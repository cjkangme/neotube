extends ../base.pug

block content
    div#video-container(data-id=`${video._id}` data-url=`${video.url}`)
        if !video.youtubeVideo
            video(src=`${video.url}`)
            div.controls-container
                div.controls__play
                    span#play.controls__playBtn
                        i.fas.fa-play
                    div.controls__time
                        span#current-time 00:00
                        span  / 
                        span#total-time 00:00
                input(type="range" min="0" step="1" value="0")#timeline
                div.controls__volume
                    input(type="range" min="0" max="1" step="0.02" value="0.5")#volume
                    span#mute
                        i.fas.fa-volume-high
                div.controls__function
                    span#loop
                        i.fas.fa-arrows-rotate
                    span#fullscreen
                        i.fas.fa-expand
        else
            iframe(id="player" type="text/html" src=`https://www.youtube.com/embed/${video.url}?rel=0&enablejsapi=1` frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen)
    div.video__comment-section
        div.video__add-comment
            if loggedIn
                form.video__comment-form
                    textarea(cols="30", rows="10", placeholder="댓글을 작성해주세요", maxlength="299").video__comment-textarea
                    button(type="submit").video__comment-btn Add Comment
            else
                form.video__comment-form
                    textarea(cols="30", rows="10", placeholder="로그인 후 이용해주세요.", disabled).video__comment-textarea
                    button(type="submit", disabled).video__comment-btn Add Comment
        div.video__comments
            each comment in video.comments.reverse()
                div.video__comment
                    a(href=`/users/${comment.owner._id}`).comment__avatar
                        if comment.owner.avaterUrl
                            img(src=`${comment.owner.avatarUrl}`)
                        else
                            div.comment__avatar-icon
                                i(class="fas fa-user")
                    a(href=`/users/${comment.owner._id}`).comment__owner=comment.owner.username
                    div.comment__created=comment.createdAt
                    div.comment__text=comment.text
                    if comment.owner._id == loggedInUser._id
                        button.comment__remove.fas.fa-xmark(data-id=comment._id)

block scripts
    if !video.youtubeVideo
        script(src="/assets/js/videoPlayer.js" type="text/javascript")
    else
        script.
            const videoContainer = document.getElementById("video-container");

            var tag = document.createElement("script");
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName("script")[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            //  after the API code downloads.
            let player;
            function onYouTubeIframeAPIReady() {
            player = new YT.Player("player", {
                rel: 0,
                events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
                },
            });
            }

            // 1) 동영상이 준비되면 발생하는 함수
            function onPlayerReady(event) {
            console.log("안되는데");
            }

            // 2) 플레이어의 상태에 따른 이벤트
            function onPlayerStateChange(event) {
                if (event.data === 0) {
                    console.log("동영상 종료");
                    const { id } = videoContainer.dataset;
                    fetch(`/api/videos/${id}/view`, {
                    method: "POST",
                    });
                }
            }
    script(src="/assets/js/commentSection.js")